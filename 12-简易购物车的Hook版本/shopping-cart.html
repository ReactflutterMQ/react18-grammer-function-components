<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./shopping-cart.css">
    <script src="../react.development.js"></script>
    <script src="../react-dom.development.js"></script>
    <script src="../babel.min.js"></script>
    <script src="../prop-types.js"></script>
    <script src="../lodash.min.js"></script>
    <script src="../immutable.min.js"></script>
</head>
<body>
    <div id="app"></div>

    <script type="text/babel">
        let app = document.querySelector('#app');
        let root = ReactDOM.createRoot(app);
        let { useState, useEffect } = React;

        // 购物车组件
        let Cart = () => {
            const [list, setList] = useState([])
            const [total, setTotal] = useState(0)

            useEffect(() => {
                fetch('./data.json').then(res => res.json())
                .then(data => {
                    if (data.errcode === 0) {
                        setList(data.list)
                    }
                })
            }, [])

            /* 每次list列表数据发生改变就重新计算total的值 */
            useEffect(() => {
                computedTotal()
            }, [list])

            const handleAdd = (id) => {
                return () => {
                    const newList = _.cloneDeep(list)
                    const item = newList.find(v => v.id === id)
                    item.number++
                    setList(newList)
                }
            }

            const handleMinus = (id) => {
                return () => {
                    const newList = _.cloneDeep(list)
                    const item = newList.find(v => v.id === id)
                    if (item.number > 1) {
                        item.number--
                        setList(newList)
                    }
                }
            }

            const handleAddToCart = (id) => {
                return () => {
                    const newList = _.cloneDeep(list)
                    const item = newList.find(v => v.id === id)
                    item.isActive = !item.isActive
                    setList(newList)
                }
            }

            const computedTotal = () => {
                const total = list.filter(v => v.isActive).reduce((prev, next) => {
                    return prev + next.price * next.number
                }, 0)
                setTotal(total)
            }

            return (
                <div className="Cart">
                    <ul>
                        {
                            list.map(v => <Items key={v.id} {...v} handleAdd={handleAdd}
                            handleMinus = {handleMinus} handleAddToCart={handleAddToCart} />)
                        }
                    </ul>
                    <span className="total">总金额：{total}元</span>
                </div>
            )
        }

        let Items = (props) => {
            const { id, isActive, name, price, number, handleAdd, handleMinus, handleAddToCart} = props
            return (
                <li className={ isActive ? 'isActive' : '' }>
                    <div className="title">{name}</div>
                    <p>单价：{price}</p>
                    <div>
                        <span className="minus" onClick={handleMinus(id)}>-</span>
                        <span className="price">{number}</span>
                        <span className="add" onClick={handleAdd(id)}>+</span>
                    </div>
                    <button onClick={handleAddToCart(id)}>{ isActive ? '取消购买' : '添加至购物车' }</button>
                </li>
            )
        }
        // 商品组件
        let element = (
            <Cart />
        )
        root.render(element);
    </script>
</body>
</html>